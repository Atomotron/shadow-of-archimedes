<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <script src="math32.js"></script>
    <script src="shadercompiler.js"></script>
    <script src="imageloader.js"></script>
    <script src="sounds.js"></script>
    <script src="canvasmanager.js"></script>
    <script src="dynamicvao.js"></script>
    <script src="scene.js"></script>
    <script src="engine.js"></script>
</head>
<body>
<h1>David Bowie Fanfiction: WebGL</h1>
<div id="canvas-container" style="height:80vh; width:100%"></div>

<script id="shader-background-v" type="x-shader/x-vertex">
attribute vec2 vertex;
varying vec2 world_coord;
uniform mat3 inverse_view;

void main() {
    gl_Position = vec4(vertex,0.0,1.0);
    world_coord = (inverse_view * vec3(vertex,1.0)).xy;
}
</script>

<script id="shader-background-f" type="x-shader/x-fragment">
precision highp float;
varying vec2 world_coord;
uniform float t;
void main() {
    float x = dot(world_coord,vec2(0.7,0.3));
    float y = dot(world_coord,vec2(0.71,1.3));
    float z = dot(world_coord,vec2(-31.0,41.0));
    gl_FragColor = vec4(0.8+sin(t*2.0+y)*0.1, 0.8+sin(t*4.0+z)*0.025, 0.8+sin(t+x)*0.3, 1.0);
}
</script>
<script>

/*
 * A custom render pass that uses the custom shaders
 */
class BackgroundPass extends RenderPass {
    constructor(gl,scene,program) {
        super(gl,program);
        this.vao = new SimpleVAO(gl,program,scene.square_vao);
        this.inverse_view_loc = gl.getUniformLocation(program,"inverse_view");
        this.t_loc = gl.getUniformLocation(program,"t");
        this.inverse_view = new Mat();
        this.t = 0;
    }
    update(scene,dt) {
        Mat.Inv(this.inverse_view,scene.view);
        this.t += dt;
    }
    draw(gl) {
        console.log("Drawing");
        gl.useProgram(this.program);
        gl.uniformMatrix3fv(this.inverse_view_loc,false,this.inverse_view.a);
        gl.uniform1f(this.t_loc,this.t);
        this.vao.draw(gl);
    }
}

class DemoEngine extends Engine {
    setup() {
        // Background pass
        this.backgroundpass = new BackgroundPass(this.gl,
            this.scene,
            this.sc.programs.get('background')
        );
        this.scene.addPass(this.backgroundpass,1.0);
    }
    update(dt) {
        super.update(dt);
        this.scene.view.a[0] = 1/this.cm.aspectRatio;
    }
}

const engine = new DemoEngine(
    canvas_container = document.getElementById("canvas-container"),
    shader_programs = {
        background:['shader-background-v','shader-background-f']
    },
    images = {
        //spritesheet:'images/hoverbots.png'
    },    
    frames = {
        //spritesheet:'images/hoverbots.json'
    },
    music = {
        //"negentropy": "sound/Chad_Crouch_-_Negentropy.mp3"
    },
    sfx = {
        //"hit": "sound/hit.mp3"
    },
);

</script>

</div>
</body>
</html>
